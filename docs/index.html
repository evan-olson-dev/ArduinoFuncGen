<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>8-Bit R-2R DAC Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        .mono {
            font-family: 'JetBrains Mono', monospace;
        }

        /* Custom Switch Styling */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #10B981;
        }

        .toggle-checkbox:checked+.toggle-label {
            background-color: #10B981;
        }
    </style>
</head>

<body class="bg-slate-900 text-slate-100 min-h-screen">

    <!-- Header -->
    <header class="bg-slate-800 border-b border-slate-700 p-6 sticky top-0 z-50 shadow-lg">
        <div class="max-w-[1800px] mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1
                    class="text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-500">
                    8-Bit R-2R DAC
                </h1>
                <p class="text-slate-400 text-sm mt-1">Interactive Simulator & Guide</p>
            </div>
            <div class="flex gap-4 text-sm font-semibold">
                <a href="#manual" class="hover:text-cyan-400 transition-colors">Manual Control</a>
                <a href="#scope" class="hover:text-cyan-400 transition-colors">Oscilloscope</a>
                <a href="#impedance" class="hover:text-cyan-400 transition-colors">The "2R" Proof</a>
            </div>
        </div>
    </header>

    <main class="max-w-[1800px] mx-auto p-6 space-y-12">

        <!-- Section 1: Manual Bit Control -->
        <section id="manual" class="space-y-6">
            <div class="flex justify-between items-end border-b border-slate-700 pb-2">
                <h2 class="text-2xl font-bold text-cyan-400">1. Manual Bit Control</h2>
                <div class="text-right">
                    <p class="text-xs text-slate-400 uppercase tracking-wider">Output Voltage</p>
                    <p id="voltage-display" class="text-4xl font-mono font-bold text-green-400">0.00 V</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Ladder Visualization -->
                <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 shadow-inner relative overflow-hidden">
                    <h3 class="text-sm font-semibold text-slate-400 mb-4 uppercase tracking-widest">Resistor Ladder
                        State</h3>

                    <!-- SVG Ladder Representation -->
                    <div class="relative h-64 w-full flex items-center justify-center">
                        <svg id="ladder-svg" width="100%" height="100%" viewBox="0 0 800 200" class="text-slate-500">
                            <!-- Main Line -->
                            <line x1="50" y1="100" x2="670" y2="100" stroke="currentColor" stroke-width="2" />

                            <!-- Legs (Bit Inputs) -->
                            <g id="leg-D0" class="transition-colors duration-300">
                                <line x1="60" y1="100" x2="60" y2="180" stroke="currentColor" stroke-width="2" />
                                <circle cx="60" cy="180" r="4" fill="currentColor" />
                            </g>
                            <g id="leg-D1" class="transition-colors duration-300">
                                <line x1="140" y1="100" x2="140" y2="180" stroke="currentColor" stroke-width="2" />
                                <circle cx="140" cy="180" r="4" fill="currentColor" />
                            </g>
                            <g id="leg-D2" class="transition-colors duration-300">
                                <line x1="220" y1="100" x2="220" y2="180" stroke="currentColor" stroke-width="2" />
                                <circle cx="220" cy="180" r="4" fill="currentColor" />
                            </g>
                            <g id="leg-D3" class="transition-colors duration-300">
                                <line x1="300" y1="100" x2="300" y2="180" stroke="currentColor" stroke-width="2" />
                                <circle cx="300" cy="180" r="4" fill="currentColor" />
                            </g>
                            <g id="leg-D4" class="transition-colors duration-300">
                                <line x1="380" y1="100" x2="380" y2="180" stroke="currentColor" stroke-width="2" />
                                <circle cx="380" cy="180" r="4" fill="currentColor" />
                            </g>
                            <g id="leg-D5" class="transition-colors duration-300">
                                <line x1="460" y1="100" x2="460" y2="180" stroke="currentColor" stroke-width="2" />
                                <circle cx="460" cy="180" r="4" fill="currentColor" />
                            </g>
                            <g id="leg-D6" class="transition-colors duration-300">
                                <line x1="540" y1="100" x2="540" y2="180" stroke="currentColor" stroke-width="2" />
                                <circle cx="540" cy="180" r="4" fill="currentColor" />
                            </g>
                            <g id="leg-D7" class="transition-colors duration-300">
                                <line x1="620" y1="100" x2="620" y2="180" stroke="currentColor" stroke-width="2" />
                                <circle cx="620" cy="180" r="4" fill="currentColor" />
                            </g>

                            <!-- Output Probe -->
                            <line x1="670" y1="100" x2="700" y2="100" stroke="#f43f5e" stroke-width="3" />
                            <circle cx="700" cy="100" r="6" fill="#f43f5e" />
                            <text x="680" y="80" fill="#f43f5e" font-size="12">Vout</text>

                            <!-- Labels -->
                            <text x="50" y="195" font-size="12" fill="currentColor">D0 (LSB)</text>
                            <text x="135" y="195" font-size="12" fill="currentColor">D1</text>
                            <text x="215" y="195" font-size="12" fill="currentColor">D2</text>
                            <text x="295" y="195" font-size="12" fill="currentColor">D3</text>
                            <text x="375" y="195" font-size="12" fill="currentColor">D4</text>
                            <text x="455" y="195" font-size="12" fill="currentColor">D5</text>
                            <text x="535" y="195" font-size="12" fill="currentColor">D6</text>
                            <text x="615" y="195" font-size="12" fill="currentColor">D7 (MSB)</text>
                        </svg>
                    </div>
                    <p class="text-xs text-center text-slate-500 mt-2">Active bits inject current into the ladder. The
                        MSB (D7) is closest to the output.</p>
                </div>

                <!-- Controls -->
                <div class="space-y-4">
                    <p class="text-slate-300 mb-4">Toggle bits to see how superposition adds voltages together.</p>

                    <div id="bit-controls" class="space-y-3">
                        <!-- Controls generated by JS -->
                    </div>

                    <div class="bg-slate-800 p-4 rounded-lg border border-slate-700 mt-6">
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-slate-400">Total Binary Value:</span>
                            <span id="binary-val" class="font-mono text-cyan-400">000000</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-slate-400">Decimal Value:</span>
                            <span id="decimal-val" class="font-mono text-cyan-400">0</span>
                        </div>
                        <div class="w-full bg-slate-700 h-2 rounded-full mt-3 overflow-hidden">
                            <div id="voltage-bar" class="bg-green-400 h-full transition-all duration-300"
                                style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 2: Oscilloscope -->
        <section id="scope" class="space-y-6">
            <div class="flex justify-between items-end border-b border-slate-700 pb-2">
                <h2 class="text-2xl font-bold text-cyan-400">2. Oscilloscope Simulator</h2>
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 rounded-full bg-red-500 animate-pulse"></div>
                    <span class="text-xs text-red-400 font-mono">LIVE</span>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Canvas -->
                <div class="lg:col-span-2 bg-black rounded-xl border-4 border-slate-600 shadow-2xl relative">
                    <!-- Grid Lines -->
                    <div class="absolute inset-0 opacity-20 pointer-events-none"
                        style="background-image: linear-gradient(#333 1px, transparent 1px), linear-gradient(90deg, #333 1px, transparent 1px); background-size: 40px 40px;">
                    </div>

                    <canvas id="scopeCanvas" width="800" height="400" class="w-full h-full block"></canvas>

                    <!-- Scope UI Overlays -->
                    <div class="absolute bottom-4 right-4 font-mono text-xs text-yellow-500">
                        TIME/DIV: <span id="scope-time">Variable</span>
                    </div>
                </div>

                <!-- Controls -->
                <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 space-y-6">
                    <div>
                        <h3 class="text-sm font-semibold text-slate-400 mb-3 uppercase tracking-widest">Waveform</h3>
                        <div class="flex gap-2">
                            <button onclick="setMode(0)" id="btn-saw"
                                class="flex-1 py-2 bg-cyan-600 hover:bg-cyan-500 rounded text-sm font-bold transition-all border border-cyan-400">Sawtooth</button>
                            <button onclick="setMode(1)" id="btn-tri"
                                class="flex-1 py-2 bg-slate-700 hover:bg-slate-600 rounded text-sm font-bold transition-all border border-slate-600">Triangle</button>
                            <button onclick="setMode(2)" id="btn-sin"
                                class="flex-1 py-2 bg-slate-700 hover:bg-slate-600 rounded text-sm font-bold transition-all border border-slate-600">Sine</button>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-sm font-semibold text-slate-400 mb-3 uppercase tracking-widest">Frequency</h3>
                        <input type="range" min="1" max="25" value="5"
                            class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-cyan-400"
                            id="freq-slider">
                        <div class="flex justify-between text-xs text-slate-500 mt-1">
                            <span>Low (Slow)</span>
                            <span>High (Fast)</span>
                        </div>
                    </div>

                    <div class="p-4 bg-slate-700/30 rounded border border-slate-600 text-sm text-slate-300">
                        <p><strong>Note:</strong> This simulates a standing wave triggering, just like a real
                            oscilloscope. Move the slider to change the time scale.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 3: Impedance Visualizer (Refined Layout) -->
        <section id="impedance" class="space-y-6">
            <div class="border-b border-slate-700 pb-2">
                <h2 class="text-2xl font-bold text-cyan-400">3. The "Infinite 2R" Proof</h2>
                <p class="text-slate-400 mt-2">Why does the resistance always look the same? Use the buttons to simplify
                    the circuit step-by-step.</p>
            </div>

            <!-- Changed Grid Layout for better spacing -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">

                <!-- SVG Container -->
                <div
                    class="bg-white relative w-full aspect-[2/1] rounded-xl flex items-center justify-center overflow-hidden border-4 border-slate-700 shadow-xl">
                    <svg id="imp-svg" width="100%" height="100%" viewBox="0 0 600 260">
                        <!-- Content generated by JS -->
                    </svg>
                </div>

                <!-- Controls/Text -->
                <div class="space-y-6 flex flex-col justify-center h-full">
                    <div id="imp-step-text"
                        class="min-h-[350px] flex flex-col justify-center bg-slate-800 p-6 rounded-lg border border-slate-600 text-sm leading-relaxed shadow-lg">
                        Loading...
                    </div>

                    <div class="flex gap-4">
                        <button onclick="prevImpStep()"
                            class="flex-1 py-3 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm font-bold border border-slate-500 transition-colors shadow-lg">Previous
                            Step</button>
                        <button onclick="nextImpStep()"
                            class="flex-1 py-3 bg-cyan-600 hover:bg-cyan-500 rounded-lg text-sm font-bold border border-cyan-400 transition-colors shadow-lg shadow-cyan-900/50">Next
                            Step</button>
                    </div>

                    <div class="bg-slate-800/50 p-4 rounded-lg border border-slate-700 text-xs text-slate-400">
                        <p class="font-bold text-slate-300 mb-2 uppercase tracking-wide">Diagram Legend</p>
                        <div class="grid grid-cols-2 gap-2">
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 bg-green-400/20 border border-green-400 rounded"></div>
                                <span>Combining Parts</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 bg-blue-600 border border-blue-600 rounded"></div>
                                <span>New Equivalent</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <footer class="text-center p-8 text-slate-600 text-sm">
        Built for the Arduino 6-Bit Function Generator Project
    </footer>

    <script>
        // --- Constants & State ---
        // 8-Bit Update
        const bits = [0, 0, 0, 0, 0, 0, 0, 0]; // D0 to D7
        const bitWeights = [1, 2, 4, 8, 16, 32, 64, 128]; // D0 LSB (1) ... D7 MSB (128)

        // Calculate voltages for display (Vref = 5V). Max voltage is 5 * (255/256).
        // Each bit contributes Vref / 2^(8-n)
        const bitVoltages = bitWeights.map(w => (5.0 * w / 256.0));

        // generate Sine Table (0-255)
        const sineTable = [];
        for (let i = 0; i < 256; i++) {
            // Map 0..255 to 0..2PI
            const angle = (i / 256.0) * 2 * Math.PI;
            // Normalize -1..1 to 0..255
            const val = Math.round(((Math.sin(angle) + 1) / 2) * 255);
            sineTable.push(val);
        }

        let mode = 0; // 0=Saw, 1=Tri, 2=Sine
        let sliderValue = 5; // Default slider position

        // Scope Canvas
        const canvas = document.getElementById('scopeCanvas');
        const ctx = canvas.getContext('2d');

        // --- Impedance Visualizer Logic ---
        let impStep = 0;

        // Simplified Explanation Steps
        const impSteps = [
            {
                text: "<strong class='text-cyan-400 text-lg block mb-2'>Step 1: The Mystery</strong><br>How does this long chain of resistors convert binary numbers into precise voltages?<br>The secret is that <strong>every single stage</strong> of the ladder is identical from an electrical perspective.<br><br>Let's look at the very end of the ladder (the LSB) to find the pattern.",
                draw: () => {
                    let s = "";
                    const y = 90;
                    // Draw a few stages
                    // Stage N-1
                    s += `<line x1="100" y1="${y}" x2="200" y2="${y}" stroke="#94a3b8" stroke-width="2"/>`;
                    s += `<rect x="200" y="${y + 20}" width="20" height="40" stroke="black" fill="white" stroke-width="2"/>`; // Leg
                    s += `<line x1="210" y1="${y}" x2="210" y2="${y + 20}" stroke="black" stroke-width="2"/>`;
                    s += `<line x1="210" y1="${y + 60}" x2="210" y2="${y + 80}" stroke="black" stroke-width="2"/>`;
                    s += drawGroundSVG(210, y + 80);
                    s += `<rect x="240" y="${y - 10}" width="40" height="20" stroke="black" fill="white" stroke-width="2"/>`; // Rung
                    s += `<line x1="210" y1="${y}" x2="240" y2="${y}" stroke="black" stroke-width="2"/>`;
                    s += `<line x1="280" y1="${y}" x2="320" y2="${y}" stroke="black" stroke-width="2"/>`;

                    // Stage N (LSB)
                    s += `<rect x="310" y="${y + 20}" width="20" height="40" stroke="black" fill="white" stroke-width="2"/>`; // Leg
                    s += `<line x1="320" y1="${y}" x2="320" y2="${y + 20}" stroke="black" stroke-width="2"/>`;
                    s += `<line x1="320" y1="${y + 60}" x2="320" y2="${y + 80}" stroke="black" stroke-width="2"/>`;
                    s += drawGroundSVG(320, y + 80);

                    // Termination
                    s += `<line x1="320" y1="${y}" x2="360" y2="${y}" stroke="black" stroke-width="2"/>`;
                    s += `<rect x="360" y="${y - 10}" width="40" height="20" stroke="black" fill="white" stroke-width="2"/>`; // Term
                    s += `<line x1="400" y1="${y}" x2="420" y2="${y}" stroke="black" stroke-width="2"/>`;
                    s += drawGroundSVG(420, y, true);

                    s += `<text x="250" y="${y - 20}" font-size="12" fill="#64748b">1R</text>`;
                    s += `<text x="190" y="${y + 100}" font-size="12" fill="#64748b">2R</text>`;
                    s += `<text x="340" y="${y + 100}" font-size="12" fill="#64748b">2R (Last Bit)</text>`;
                    s += `<text x="360" y="${y - 20}" font-size="12" fill="#64748b">2R (Term)</text>`;

                    return s;
                }
            },
            {
                text: "<strong class='text-cyan-400 text-lg block mb-2'>Step 2: The 'Two Roads' Split</strong><br>Look at the junction at the last bit.<br>1. The path <strong>Down</strong> (the bit input) goes through a <strong>2R</strong> resistor.<br>2. The path <strong>Right</strong> (to ground) also goes through a <strong>2R</strong> resistor.<br><br>Since both paths have <strong>identical resistance (2R)</strong>, any current arriving here splits exactly 50/50. This means the voltage is cut in half!",
                draw: () => {
                    let s = `<line x1="200" y1="90" x2="320" y2="90" stroke="#94a3b8" stroke-width="2"/>`;

                    // Highlight Down
                    s += `<rect x="310" y="110" width="20" height="40" stroke="#f43f5e" fill="white" stroke-width="2"/>`;
                    s += `<line x1="320" y1="90" x2="320" y2="110" stroke="#f43f5e" stroke-width="2"/>`;
                    s += `<line x1="320" y1="150" x2="320" y2="170" stroke="#f43f5e" stroke-width="2"/>`;
                    s += `<text x="320" y="185" fill="#f43f5e" font-weight="bold" text-anchor="middle">Path A: 2R</text>`;
                    s += drawGroundSVG(320, 170);

                    // Highlight Right
                    s += `<rect x="360" y="80" width="40" height="20" stroke="#f43f5e" fill="white" stroke-width="2"/>`;
                    s += `<line x1="320" y1="90" x2="360" y2="90" stroke="#f43f5e" stroke-width="2"/>`;
                    s += `<line x1="400" y1="90" x2="420" y2="90" stroke="#f43f5e" stroke-width="2"/>`;
                    s += `<text x="360" y="60" fill="#f43f5e" font-weight="bold" text-anchor="middle">Path B: 2R</text>`;
                    s += drawGroundSVG(420, 90, true);

                    // Arrows showing split
                    s += `<path d="M 280 80 L 310 80" stroke="#22d3ee" stroke-width="3" marker-end="url(#arrow)"/>`;
                    s += `<path d="M 320 100 L 320 120" stroke="#22d3ee" stroke-width="2" stroke-dasharray="4"/>`;
                    s += `<path d="M 330 90 L 350 90" stroke="#22d3ee" stroke-width="2" stroke-dasharray="4"/>`;

                    return s;
                }
            },
            {
                text: "<strong class='text-cyan-400 text-lg block mb-2'>Step 3: Why it Repeats</strong><br>Now, what is the <i>equivalent resistance</i> of two 2R resistors in parallel?<br><br><span class='font-mono bg-slate-900 px-2 py-1 rounded text-green-400'>2R || 2R = 1R</span><br><br>Wait! If we add the horizontal rung (1R) to this equivalent (1R), we get <strong>2R again</strong>.<br>This means the circuit looks like 2R to the previous stage, too! The pattern repeats forever.",
                draw: () => {
                    let s = "";
                    // Equivalent box
                    s += `<rect x="300" y="70" width="140" height="120" stroke="#4ade80" fill="rgba(74, 222, 128, 0.1)" rx="10"/>`;
                    s += `<text x="320" y="180" fill="#4ade80" font-weight="bold">Equivalent = 1R</text>`;

                    // The components
                    s += `<rect x="310" y="110" width="20" height="40" stroke="black" fill="white" stroke-width="2"/>`;
                    s += `<line x1="320" y1="90" x2="320" y2="110" stroke="black" stroke-width="2"/>`;
                    s += `<line x1="320" y1="150" x2="320" y2="170" stroke="black" stroke-width="2"/>`;
                    s += drawGroundSVG(320, 170);

                    s += `<rect x="360" y="80" width="40" height="20" stroke="black" fill="white" stroke-width="2"/>`;
                    s += `<line x1="320" y1="90" x2="360" y2="90" stroke="black" stroke-width="2"/>`;
                    s += `<line x1="400" y1="90" x2="420" y2="90" stroke="black" stroke-width="2"/>`;
                    s += drawGroundSVG(420, 90, true);

                    // Previous Rung
                    s += `<rect x="240" y="80" width="40" height="20" stroke="#facc15" fill="white" stroke-width="2"/>`;
                    s += `<line x1="280" y1="90" x2="320" y2="90" stroke="black" stroke-width="2"/>`;
                    s += `<line x1="200" y1="90" x2="240" y2="90" stroke="black" stroke-width="2"/>`;
                    s += `<text x="240" y="70" fill="#facc15" font-weight="bold">Previous (1R)</text>`;

                    return s;
                }
            },
            {
                text: "<strong class='text-cyan-400 text-lg block mb-2'>Step 4: The Result</strong><br>Because every stage sees exactly '2R' looking down the line, the voltage divider rule applies equally at every single step.<br><br>Each step to the left doubles the effect of the bit.<br>D7 (MSB) -> 1/2 Vref<br>D6 -> 1/4 Vref<br>D5 -> 1/8 Vref... and so on.<br><br>This is why R-2R is so powerful: it uses just two resistor values to create precise binary divisions.",
                draw: () => {
                    let s = `<text x="300" y="100" text-anchor="middle" fill="white" font-size="20">Each Step = รท 2</text>`;
                    s += `<line x1="100" y1="120" x2="500" y2="120" stroke="#22d3ee" stroke-width="2" marker-end="url(#arrow)"/>`;
                    s += `<circle cx="150" cy="120" r="5" fill="#22d3ee"/>`;
                    s += `<circle cx="250" cy="120" r="5" fill="#22d3ee"/>`;
                    s += `<circle cx="350" cy="120" r="5" fill="#22d3ee"/>`;
                    s += `<circle cx="450" cy="120" r="5" fill="#22d3ee"/>`;
                    s += `<text x="150" y="150" fill="#22d3ee" text-anchor="middle">1/8</text>`;
                    s += `<text x="250" y="150" fill="#22d3ee" text-anchor="middle">1/4</text>`;
                    s += `<text x="350" y="150" fill="#22d3ee" text-anchor="middle">1/2</text>`;
                    s += `<text x="450" y="150" fill="#22d3ee" text-anchor="middle">Input</text>`;
                    return s;
                }
            }
        ];

        function renderImpStep() {
            const container = document.getElementById('imp-svg');
            const s = impSteps[impStep];
            document.getElementById('imp-step-text').innerHTML = s.text;
            container.innerHTML = s.draw();
        }

        function drawGroundSVG(x, y, sideways = false) {
            if (sideways) {
                return `
                    <line x1="${x}" y1="${y}" x2="${x}" y2="${y + 10}" stroke="black" stroke-width="2" transform="rotate(-90 ${x} ${y})"/>
                    <line x1="${x - 10}" y1="${y + 10}" x2="${x + 10}" y2="${y + 10}" stroke="black" stroke-width="2" transform="rotate(-90 ${x} ${y})"/>
                    <line x1="${x - 6}" y1="${y + 14}" x2="${x + 6}" y2="${y + 14}" stroke="black" stroke-width="2" transform="rotate(-90 ${x} ${y})"/>
                    <line x1="${x - 2}" y1="${y + 18}" x2="${x + 2}" y2="${y + 18}" stroke="black" stroke-width="2" transform="rotate(-90 ${x} ${y})"/>
                `;
            }
            return `
                <line x1="${x - 10}" y1="${y}" x2="${x + 10}" y2="${y}" stroke="black" stroke-width="2"/>
                <line x1="${x - 6}" y1="${y + 4}" x2="${x + 6}" y2="${y + 4}" stroke="black" stroke-width="2"/>
                <line x1="${x - 2}" y1="${y + 8}" x2="${x + 2}" y2="${y + 8}" stroke="black" stroke-width="2"/>
            `;
        }

        window.nextImpStep = function () {
            if (impStep < impSteps.length - 1) impStep++;
            renderImpStep();
        };
        window.prevImpStep = function () {
            if (impStep > 0) impStep--;
            renderImpStep();
        };


        // --- Initialization ---
        function init() {
            createManualControls();
            updateManualDisplay();
            scopeLoop(); // Start animation loop
            renderImpStep(); // Start impedance tool
        }

        // --- Manual Control Section ---
        function createManualControls() {
            const container = document.getElementById('bit-controls');
            container.innerHTML = ""; // Clear existing
            // Create controls in reverse order (D7 top, D0 bottom)
            for (let i = 7; i >= 0; i--) {
                const pinName = `D${i}`;
                const label = i === 7 ? "MSB (Most Significant)" : i === 0 ? "LSB (Least Significant)" : "";
                const voltage = bitVoltages[i].toFixed(3);

                const div = document.createElement('div');
                div.className = "flex items-center justify-between bg-slate-700/50 p-3 rounded hover:bg-slate-700 transition-colors";
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="font-mono font-bold text-lg w-8 text-slate-300">${pinName}</span>
                        <span class="text-xs text-slate-400 uppercase">${label}</span>
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="font-mono text-cyan-400 text-sm">+${voltage}V</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" class="sr-only peer" onchange="toggleBit(${i})">
                            <div class="w-11 h-6 bg-slate-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-cyan-500"></div>
                        </label>
                    </div>
                `;
                container.appendChild(div);
            }
        }

        window.toggleBit = function (index) {
            bits[index] = bits[index] === 0 ? 1 : 0;
            updateManualDisplay();

            // Visual feedback on ladder SVG
            const legId = `leg-D${index}`;
            const leg = document.getElementById(legId);
            if (bits[index]) {
                leg.classList.add('text-green-400');
                leg.classList.remove('text-slate-500');
            } else {
                leg.classList.remove('text-green-400');
                leg.classList.add('text-slate-500');
            }
        };

        function calculateVoltage(val) {
            // 8-bit quantization: Max val is 255.
            // Theoretical max voltage in R-2R is Vref * (255/256).
            return (val / 256.0) * 5.0;
        }

        function updateManualDisplay() {
            // Calculate decimal value from bits
            let decimal = 0;
            let binaryStr = "";
            for (let i = 7; i >= 0; i--) {
                if (bits[i]) decimal += bitWeights[i];
                binaryStr += bits[i];
            }

            const volts = calculateVoltage(decimal);

            // DOM Updates
            document.getElementById('voltage-display').innerText = volts.toFixed(2) + " V";
            document.getElementById('binary-val').innerText = binaryStr;
            document.getElementById('decimal-val').innerText = decimal;

            // Bar Width
            const pct = (decimal / 255) * 100;
            document.getElementById('voltage-bar').style.width = `${pct}%`;
        }

        // --- Oscilloscope Section ---

        // Mode Switching
        window.setMode = function (m) {
            mode = m;
            // Reset highlighting
            ['btn-saw', 'btn-tri', 'btn-sin'].forEach(id => {
                document.getElementById(id).classList.replace('bg-cyan-600', 'bg-slate-700');
                document.getElementById(id).classList.replace('border-cyan-400', 'border-slate-600');
            });
            // Highlight active
            const activeBtn = ['btn-saw', 'btn-tri', 'btn-sin'][m];
            document.getElementById(activeBtn).classList.replace('bg-slate-700', 'bg-cyan-600');
            document.getElementById(activeBtn).classList.replace('border-slate-600', 'border-cyan-400');
        };

        // Slider
        document.getElementById('freq-slider').addEventListener('input', (e) => {
            sliderValue = parseInt(e.target.value);
        });

        // Loop
        function scopeLoop() {
            drawScope();
            requestAnimationFrame(scopeLoop);
        }

        // Returns DAC value (0-255) for a given time step t
        function getDacValueAtTime(t) {
            // Sawtooth: 0..255 repeat
            if (mode === 0) {
                return t % 256;
            }
            // Triangle: 0..255..0 repeat (Period 510 approx)
            else if (mode === 1) {
                const period = 510;
                const phase = t % period;
                if (phase <= 255) return phase;
                else return 510 - phase;
            }
            // Sine: Lookup table
            else if (mode === 2) {
                return sineTable[t % 256];
            }
            return 0;
        }

        function drawScope() {
            // Clear Screen
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const timeMultiplier = sliderValue / 10.0;

            // Draw Beam
            ctx.beginPath();
            ctx.lineWidth = 3;
            ctx.strokeStyle = '#22d3ee';
            ctx.shadowBlur = 10;
            ctx.shadowColor = ctx.strokeStyle;

            // We iterate pixels across the screen
            for (let x = 0; x < canvas.width; x++) {

                // Convert screen X pixel to a virtual time 't'
                const t = Math.floor(x * timeMultiplier);

                // Get the voltage level (0-255)
                const val = getDacValueAtTime(t);
                const volts = calculateVoltage(val);

                // Map Volts to Y
                // 5V = 50px, 0V = 350px (300px range)
                const y = 350 - (volts / 5.0 * 300);

                if (x === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();

            // Draw Center Line (Ground) slightly visible
            ctx.strokeStyle = '#333';
            ctx.shadowBlur = 0;
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(0, 350);
            ctx.lineTo(800, 350);
            ctx.stroke();

            document.getElementById('scope-time').innerText = (sliderValue * 50) + " Hz";
        }

        init();
    </script>
</body>

</html>